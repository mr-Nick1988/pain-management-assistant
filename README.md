# Pain Management Assistant - Frontend

## Описание проекта

Фронтенд приложения для управления болью в медицинских учреждениях. Построен на React + TypeScript + Vite с
использованием Redux Toolkit Query для управления состоянием и API.

## Технологический стек

- **React 19.1.1** - основной фреймворк
- **TypeScript 5.8.3** - типизация
- **Vite 7.1.2** - сборщик и dev-сервер
- **Redux Toolkit 2.9.0** - управление состоянием
- **React Router DOM 7.9.1** - роутинг
- **Tailwind CSS 4.0.0** - стилизация

## Структура проекта

### Компоненты (`/src/components/`)

Реализованные компоненты:

- **Login.tsx** (4KB) - Авторизация пользователей
- **AdminPanel.tsx** (7KB) - Панель администратора для управления пользователями
- **DoctorDashboard.tsx** (7KB) - Дашборд доктора с рекомендациями
- **AddPatient.tsx** (4KB) - Форма добавления пациента
- **PatientRecommendationForm.tsx** (8KB) - Форма работы с рекомендациями
- **PersonsList.tsx** (2KB) - Список пользователей системы
- **ChangeCredentials.tsx** (5KB) - Смена логина и пароля
- **Navigation.tsx** (1KB) - Навигационное меню
- **Register.tsx** (2KB) - Регистрация пользователей

Заготовки компонентов (пустые файлы):

- **AnesthesiologistDashboard.tsx** (0 байт) - планируется дашборд анестезиолога
- **EscalationsList.tsx** (0 байт) - планируется список эскалаций

### API слои (`/src/api/api/`)

- **apiPersonSlice.ts** (1KB) - API для авторизации и смены креденшиалов
- **apiAdminSlice.ts** (1KB) - API для управления пользователями
- **apiDoctorSlice.ts** (3KB) - API для работы с пациентами и рекомендациями
- **apiAnesthesiologistSlice.ts** (1KB) - API для анестезиолога (в разработке)

### Типы данных (`/src/types/`)

- **personRegister.ts** - Типы для пользователей, ролей, авторизации
- **doctor.ts** - Типы для рекомендаций и пациентов
- **anesthesiologist.ts** - Типы для модуля анестезиолога

### Роутинг (`/src/routes/`)

- **AppRoutes.tsx** - Основные маршруты приложения
- **ProtectedRoute.tsx** - Компонент защищенных маршрутов

Настроенные маршруты:

- `/login` - Авторизация
- `/admin` - Панель администратора
- `/doctor` - Дашборд доктора
- `/anesthesiologist` - Дашборд анестезиолога (компонент пустой)
- `/change-credentials` - Смена креденшиалов

### Redux Store (`/src/store/`)

Настроен store с подключенными API слайсами:

- apiAdminSlice
- apiPersonSlice
- apiDoctorSlice

## Реализованный функционал

### Модуль авторизации

- Логин с сохранением данных в localStorage
- Смена временных креденшиалов при первом входе
- Защищенные маршруты с проверкой авторизации

### Модуль администратора

- Создание пользователей с ролями (ADMIN, DOCTOR, NURSE, ANESTHESIOLOGIST)
- Просмотр списка всех пользователей
- Удаление пользователей по personId
- Обновление данных пользователей

### Модуль доктора

- Просмотр списка рекомендаций
- Создание новых пациентов
- Работа с рекомендациями (одобрение/отклонение)
- Добавление комментариев к рекомендациям
- **Поиск пациентов:** поиск по любым критериям (имя, фамилия, дата рождения, страховка, MRN)

### UI/UX

- Современный дизайн с Tailwind CSS
- Адаптивная верстка
- Модальные окна для форм
- Обработка состояний загрузки и ошибок

## В разработке

- Модуль анестезиолога (компоненты созданы, но пустые)
- Список эскалаций
- Расширенная работа с протоколами

## Архитектурные решения

- Использование RTK Query для кэширования и управления API запросами
- Разделение API по доменам (admin, doctor, person, anesthesiologist)
- Строгая типизация всех компонентов и API
- Модульная структура с четким разделением ответственности

## Хронология разработки модуля анестезиолога

### 20.09.2025 - Реализация модуля анестезиолога

**Разработчик:** Ник

#### Созданные компоненты и файлы:

**1. Типы данных (`/src/types/anesthesiologist.ts`)**

- `EscalationStatus` enum - статусы эскалаций (PENDING, IN_REVIEW, RESOLVED, REJECTED)
- `ProtocolStatus` enum - статусы протоколов (DRAFT, PENDING_APPROVAL, APPROVED, REJECTED)
- `EscalationPriority` enum - приоритеты эскалаций (LOW, MEDIUM, HIGH, CRITICAL)
- `Escalation` interface - структура эскалации с полями patientName, doctorName, rejectedReason, priority, status
- `Protocol` interface - структура протокола с версионированием, комментариями, статусом
- `ProtocolComment` interface - комментарии к протоколам с автором и временными метками
- `CreateProtocolRequest` и `UpdateProtocolRequest` - DTO для создания и обновления протоколов

**2. API слой (`/src/api/api/apiAnesthesiologistSlice.ts`)**
Создан RTK Query API слайс с эндпоинтами:

- `getEscalations` - получение списка эскалаций
- `takeEscalation` - взятие эскалации в работу
- `getProtocolsByEscalation` - получение протоколов по эскалации
- `createProtocol` - создание нового протокола
- `updateProtocol` - обновление протокола
- `approveProtocol` - утверждение протокола
- `rejectProtocol` - отклонение протокола
- `getProtocolComments` - получение комментариев к протоколу
- `addProtocolComment` - добавление комментария
- `sendQuestionToDoctor` - отправка вопроса доктору
- `resolveEscalation` - завершение эскалации

**3. Основной компонент (`/src/components/AnesthesiologistDashboard.tsx`)**
Реализован главный дашборд анестезиолога с:

- **Вкладочной навигацией:** Overview, Escalations, Protocols
- **Статистическими карточками:** Pending, Critical, High Priority, In Review escalations
- **Быстрыми действиями:** переход к эскалациям и создание протоколов
- **Превью последних эскалаций** с возможностью выбора для работы
- **Интеграцией с дочерними компонентами:** EscalationsList и ProtocolEditor
- **Обработкой состояний загрузки и ошибок**

**4. Список эскалаций (`/src/components/EscalationsList.tsx`)**
Компонент для работы со списком эскалаций:

- **Фильтрация по статусу и приоритету**
- **Поиск по имени пациента и доктора**
- **Сортировка по дате создания и приоритету**
- **Действия:** взятие в работу, отправка вопроса доктору
- **Отображение детальной информации** по каждой эскалации

**5. Редактор протоколов (`/src/components/ProtocolEditor.tsx`)**
Продвинутый компонент для работы с протоколами:

- **Создание новых протоколов** с заголовком и содержимым
- **Редактирование существующих протоколов** с версионированием
- **Система комментариев** с возможностью добавления и просмотра
- **Утверждение/отклонение протоколов** с обязательными комментариями
- **Завершение эскалаций** после утверждения протокола
- **Безопасная работа с optional chains** (исправлены ESLint ошибки)

#### Интеграция с системой:

**1. Роутинг (`/src/routes/AppRoutes.tsx`)**

- Добавлен защищенный маршрут `/anesthesiologist`
- Подключен AnesthesiologistDashboard компонент

**2. Экспорты (`/src/exports/exports.ts`)**

- Добавлены экспорты всех компонентов модуля анестезиолога
- Обеспечена правильная структура импортов

**3. Redux Store **

- подключил `apiAnesthesiologistSlice` к основному store
- Добавил middleware для корректной работы RTK Query

#### Архитектурные особенности модуля:

**1. Разделение ответственности:**

- Dashboard - общий обзор и навигация
- EscalationsList - работа со списком эскалаций
- ProtocolEditor - создание и редактирование протоколов

**2. Типизация:**

- Строгая типизация всех API запросов и ответов
- Использование TypeScript enums для статусов и приоритетов
- Валидация данных на уровне интерфейсов

**3. Состояние и кэширование:**

- RTK Query для автоматического кэширования API данных
- Оптимистичные обновления для улучшения UX
- Правильная обработка состояний загрузки и ошибок

**4. UX/UI особенности:**

- Адаптивный дизайн с использованием CSS Grid и Flexbox
- Модальные окна для форм
- Цветовая индикация приоритетов и статусов эскалаций
- Быстрые действия и горячие клавиши для повышения продуктивности

#### Следующие шаги:

1. Подключение `apiAnesthesiologistSlice` к Redux store
2. Тестирование интеграции с backend API
3. Добавление unit тестов для компонентов
4. Оптимизация производительности и UX

---
*Разработчик: Ник*  
*Последнее обновление: 20.09.2025*

## 24.09.2025 - Отладка и восстановление функционала создания пациента

**Разработчик:** Ник

#### Описание проблемы:

В модуле доктора была обнаружена критическая ошибка, не позволявшая создавать новых пациентов. При попытке отправки
формы фронтенд получал ошибку `500 Internal Server Error`. Кроме того, на дашборде доктора отсутствовала кнопка для
вызова формы создания пациента.

#### Процесс отладки и исправления:

**1. Восстановление UI в `DoctorDashboard.tsx`**

- **Проблема:** В компоненте `DoctorDashboard` полностью отсутствовала логика для вызова модального окна `AddPatient`.
- **Решение:**
    - Добавлена кнопка "Add New Patient".
    - Внедрено состояние `isAddPatientModalOpen` для управления видимостью модального окна.
    - Реализована логика открытия/закрытия окна и обновления данных (`refetch`) после успешного создания пациента.

**2. Отладка ошибки 500 `Internal Server Error`**

- **Анализ логов:** Бэкенд логи показали ошибку `java.lang.RuntimeException: Person not found`, вызванную тем, что в
  запросе на создание пациента передавалось пустое поле `createdBy: ''`.
- **Проблема:** Фронтенд не получал и не передавал логин пользователя, создающего пациента.

**3. Исправление логики в `AddPatient.tsx`**

- **Решение:**
    - В `handleSubmit` добавлено получение логина текущего пользователя из `localStorage.getItem("userLogin")`.
    - Этот логин теперь корректно передается в поле `createdBy` при вызове мутации `createPatient`.

**4. Обновление API и типов**

- **`apiDoctorSlice.ts`:** Эндпоинт `createPatient` был обновлен для передачи `createdBy` в качестве
  query-параметра (`/api/doctor/patients?createdBy=...`).
- **`doctor.ts`:** В интерфейс `PatientCreation` было добавлено обязательное поле `createdBy: string`.

#### Ключевые результаты:

1. **Восстановлен функционал:** Доктора снова могут создавать пациентов через интерфейс `DoctorDashboard`.
2. **Исправлена интеграция:** Устранена ошибка `Person not found` путем корректной передачи данных о создателе пациента
   с фронтенда на бэкенд.
3. **Улучшена стабильность:** Проблема, блокировавшая ключевой сценарий использования приложения, была полностью решена.

---
*Разработчик: Ник*  
*Последнее обновление: 24.09.2025*

## 27.09.2025 - Исправление функционала поиска пациентов для доктора

**Разработчик:** Ник

#### Описание проблемы:

В модуле доктора была обнаружена критическая проблема с поиском пациентов. При нажатии кнопки "Search" ничего не
происходило - запросы не отправлялись на бэкенд, и пользователи не могли найти существующих пациентов. Кроме того,
бэкенд логика поиска требовала одновременного заполнения всех полей, что делало поиск практически невозможным.

#### Процесс отладки и исправления:

**1. Анализ проблемы кнопки Search (Frontend)**

- **Проблема:** В `SearchPatients.tsx` использовался `useSearchPatientsQuery` с параметром `skip: true` и попыткой
  вызова `refetch()` при нажатии кнопки.
- **Корень проблемы:** RTK Query имеет фундаментальное ограничение - `refetch()` не работает на запросах с `skip: true`.
  Пропущенные запросы не могут быть перезапущены через `refetch()`.
- **Решение:**
    - Заменен `useSearchPatientsQuery` на `useLazySearchPatientsQuery` для ручного управления запросами.
    - Добавлен `triggerSearch` для явной отправки запроса при нажатии кнопки Search.
    - Обновлен импорт в `apiDoctorSlice.ts` - добавлен `useLazySearchPatientsQuery`.

**2. Исправление логики поиска на бэкенде**

- **Проблема:** Бэкенд требовал одновременного заполнения всех полей поиска (MRN ИЛИ insurance ИЛИ dateOfBirth +
  firstName + lastName), что делало поиск неудобным.
- **Анализ кода:** Логика в `searchPatients()` использовала жесткие условия `else if`, требующие все поля одновременно.
- **Решение:** Переписана логика поиска для поддержки поиска по любым предоставленным параметрам:
    - Поиск по MRN (если предоставлен)
    - Поиск по insurance (если предоставлен)
    - Поиск по имени (firstName + lastName, опционально с dateOfBirth)
    - Удаление дубликатов при нахождении пациента несколькими способами

**3. Обновление состояния компонента SearchPatients**

- **Добавлен флаг `hasSearched`:** Для корректного отображения сообщения "No patients found" только после выполнения
  поиска.
- **Улучшена логика отображения:** Результаты показываются только после успешного поиска.

#### Ключевые результаты:

1. **Восстановлен функционал поиска:** Доктора могут успешно искать пациентов по любым критериям (имя, фамилия, дата
   рождения, страховка, MRN).
2. **Исправлена архитектурная проблема:** Замена на Lazy Query решила фундаментальную проблему RTK Query с пропущенными
   запросами.
3. **Улучшен UX:** Поиск работает по любому набору параметров, а не требует заполнения всех полей одновременно.
4. **Полная интеграция:** Фронтенд корректно отправляет запросы, бэкенд правильно обрабатывает поиск, результаты
   отображаются пользователю.

**Тестирование подтверждено:** Поиск пациентов работает корректно с любым количеством заполненных полей.

---
*Разработчик: Ник*  
*Последнее обновление: 27.09.2025*
-----------------------------------------------------------------
Евгений:

🧩 Frontend Update — 2025-10-06
📦 Общая цель

Рефакторинг и оптимизация фронтенд-части модуля Nurse для корректного отображения данных EMR и Recommendations.
Удалены устаревшие и дублирующиеся поля, добавлены новые интерфейсы и компоненты, а также реализована базовая валидация
EMR-формы.

🧠 1. Обновления в типах (/types/nurse.ts)
Удалено поле avoidIfSensitivity (устаревшее, дублировало поле sensitivities из EMR).
В интерфейсе DrugRecommendation удалены ненужные поля:
ageAdjustment, weightAdjustment, childPugh
Эти корректировки теперь обрабатываются на backend-уровне в алгоритме TreatmentProtocolService.
Поле sensitivities в EMR определено как массив строк (string[]).

🩺 2. Компоненты EMR
🔹 emr-form-register.tsx
Добавлено новое поле Sensitivities (множественный ввод, тип string[]).
Подключена валидация через функцию validateEmrField (см. раздел 4).
🔹 emr-update-form.tsx
Аналогичные изменения: добавлено редактирование поля sensitivities.
Улучшен UI (отступы, структура отображения, читаемость).

💊 3. Компоненты Recommendation
🔹 RecommendationDetails.tsx
Новая компонента, отображающая полные данные сгенерированной рекомендации:
Статус, иерархия (regimenHierarchy), дата и автор создания.
Список вложенных препаратов (DrugRecommendation[]):
drugName, activeMoiety, dosing, interval, route, role.
Разделы comments и contraindications.
Адаптирована под медсестринский интерфейс (без rejectedReason и корректировочных полей).
🔹 generate-recommendation-form.tsx
Переработан для поддержки нового формата DTO.
Обновлено взаимодействие с API-эндпоинтом createRecommendation.
Также добавлен функционал в Api Slice (соответсвенно на бэкенде)
метод по запросу последней рекоммендации пациента с поным его отображением
(кнопка в компоненте Person Details)

🧰 4. Валидация (/utils/validation-emr.ts)
Создан новый модуль validation-emr.ts.
Экспортируется стрелочная функция validateEmrField(fieldName, value):
Проверяет корректность введённых данных для каждого поля EMR.
Возвращает сообщение об ошибке (или null при валидности).
Интегрирована во все формы, где вводятся параметры EMR.

👨‍⚕️ 5. Обновления в модуле Doctor

Временно добавлено поле sensitivities в соответствующие компоненты EMR-блока доктора.
(Изменение техническое — для успешной компиляции TypeScript и запуска фронта.
Не влияет на бизнес-логику Doctor-модуля.)

🧹 6. Прочие улучшения

Мелкие правки отступов, форматирования и структуры JSX для повышения читаемости.
Удалены неиспользуемые импорты и устаревшие фрагменты комментариев.
Обновлён PatientDetails.tsx:
Расширен блок EMR Details (все 8 полей, включая sensitivities).
Добавлен блок Recommendation Details с полным отображением вложенных данных.

Add-Content -Path "C:\front_projects\pain_management_assistant\README.md" -Value @"

## 08.10.2025 - Приведение модуля анестезиолога к стандарту бэкенда

**Разработчик:** Ник

#### Описание проблемы:

Модуль анестезиолога содержал несоответствия с бэкенд API. В типах приоритетов эскалаций использовался
уровень `CRITICAL`, которого не существует в бэкенде. Это приводило к ошибкам типизации и потенциальным проблемам при
отправке данных на сервер.

#### Процесс исправления:

**1. Анализ бэкенд API**

- **Проблема:** Фронтенд использовал 4 уровня приоритета (LOW, MEDIUM, HIGH, CRITICAL), а бэкенд поддерживает только 3 (
  LOW, MEDIUM, HIGH).
- **Последствия:** TypeScript ошибки при работе с эскалациями, невозможность корректно отобразить приоритеты.

**2. Обновление типов в `src/types/anesthesiologist.ts`**

- **Решение:**
    - Удален уровень `CRITICAL` из enum `EscalationPriority`
    - Оставлены только валидные значения: `HIGH`, `MEDIUM`, `LOW`
    - Приведено к единому стандарту с бэкенд моделью

**3. Добавление новых эндпоинтов в `src/api/api/apiAnesthesiologistSlice.ts`**

- **Решение:**
    - Добавлен эндпоинт `approveEscalation` - POST `/anesthesiologist/escalations/{id}/approve`
    - Добавлен эндпоинт `rejectEscalation` - POST `/anesthesiologist/escalations/{id}/reject`
    - Оба эндпоинта принимают `EscalationResolution` с полями: `resolvedBy`, `resolution`, `approved`
    - Добавлена инвалидация тегов для автоматического обновления списка эскалаций после approve/reject

**4. Интеграция approve/reject в `EscalationsList.tsx`**

- **Решение:**
    - Добавлены модальные окна для approve и reject эскалаций
    - Реализована логика отправки resolution с текстом объяснения
    - Добавлена валидация - нельзя approve/reject без текста resolution
    - Кнопки approve/reject показываются только для эскалаций со статусом PENDING или IN_PROGRESS

**5. Рефакторинг компонентов**

- **`EscalationsList.tsx`:** Обновлена логика отображения приоритетов - убраны проверки на CRITICAL
- **`AnesthesiologistDashboard.tsx`:** Обновлена логика фильтрации и отображения статистики по приоритетам

#### Ключевые результаты:

1. **Соответствие бэкенду:** Типы приоритетов теперь полностью соответствуют API
2. **Новый функционал:** Анестезиолог может approve/reject эскалации прямо из списка
3. **Устранены ошибки типизации:** TypeScript больше не выдает ошибки при работе с приоритетами
4. **Корректная работа:** Эскалации правильно отображаются, фильтруются и обрабатываются

---
*Разработчик: Ник*  
*Последнее обновление: 08.10.2025*

## Анализ UI компонентов - Отчет об использовании

### Используемые UI компоненты (20 из 24):

1. **Button.tsx** - 29 файлов (все модули)
2. **Card.tsx** - 20+ файлов (все модули)
3. **Input.tsx** - 15+ файлов (формы)
4. **Modal.tsx** - 2 файла (Admin, Nurse)
5. **ErrorMessage.tsx** - 5+ файлов
6. **LoadingSpinner.tsx** - 3 файла
7. **PageHeader.tsx** - 2 файла (Nurse)
8. **ActionCard.tsx** - 1 файл (Nurse)
9. **SearchCard.tsx** - 1 файл (Nurse)
10. **DataCard.tsx** - 1 файл (Nurse)
11. **InfoGrid.tsx** - 1 файл (Nurse)
12. **FormCard.tsx** - 2 файла (Nurse)
13. **Select.tsx** - 2 файла (Doctor)
14. **StatCard.tsx** - 1 файл (Anesthesiologist)
15. **Container.tsx** - 2 файла (Login)
16. **GradientButton.tsx** - 2 файла (Login)
17. **GradientTitle.tsx** - 2 файла (Login)
18. **FormField.tsx** - 2 файла (Login)
19. **NavigationContainer.tsx** - 1 файл
20. **NoticeContainer.tsx** - 1 файл

**Статистика использования:** 83% UI компонентов активно используются в приложении

---
*Разработчик: Ник*  
*Последнее обновление: 08.10.2025*

## Евгений

💻 Frontend — Прогресс за 15 октября 2025
Работа с EMR (медицинская карта пациента):
Добавлено новое поле диагнозы (Diagnoses) в структуру EMR.
Создан интерфейс Diagnosis с двумя полями:
icdCode — код заболевания по международной классификации (ICD),
description — текстовое описание диагноза.

Поле диагнозов интегрировано во все соответствующие компоненты:
формы создания и обновления EMR (Doctor и Nurse модули),
компонент просмотра EMR (PatientDetails).
Добавлено корректное отображение списка диагнозов в UI (с поддержкой множественных диагнозов).

Интеграция с ICD-модулем:
В apiDoctorSlice и apiNurseSlice добавлен новый запрос к backend-контроллеру ICD-CSV Loader.
Реализован механизм автоподсказки при вводе заболевания:
при наборе текста в input-поле выполняется запрос к мини-сервису icd-diagnosis,
и пользователю предлагаются совпадения из загруженного ICD-классификатора (около 75 000 болезней).

Обновления интерфейса:
Обновлены формы создания и редактирования EMR для корректной работы с новыми полями.
Визуально улучшено отображение карточек пациента и медицинской карты (в Doctor и Nurse модулях).
Проведено ручное тестирование навигации и интеграции между модулями EMR и ICD-поиска.

## Евгений 23.10.2025

🔄 Обновление фронтенда: синхронизация между Doctor и Nurse API
Чтобы обеспечить автоматическое обновление данных между панелями врача и медсестры, реализован механизм listener
middleware, который связывает их API-слайсы.
Ранее после подтверждения или отклонения рекомендации врачом статус на стороне медсестры не обновлялся, так как каждый
модуль имел собственный RTK Query-кэш, не связанный между собой.
Изменения по шагам:
Создан общий middleware-слушатель (listenerMiddleware.ts) — базовый слой, который позволяет реагировать на события из
разных частей приложения.
Добавлен файл-мост (apiBridgeListener.ts) — он отслеживает успешные действия врача (например, approve или reject
рекомендации) и автоматически инвалидирует (очищает) кеш у медсестры, чтобы та получила обновлённые данные.
Также добавлен обратный слушатель: если медсестра создаёт новую рекомендацию, обновляется кеш у врача.
Middleware подключён к Redux-store — в конфигурации store.ts listener добавлен перед всеми RTK Query-middleware, чтобы
события обрабатывались первыми.
Кроме того, сам файл apiBridgeListener.ts импортируется в store, чтобы слушатели зарегистрировались при запуске
приложения.
Результат: теперь при любом действии врача или медсестры кеш в соответствующем модуле автоматически обновляется, и оба
интерфейса всегда отображают актуальные статусы рекомендаций без ручного обновления страницы.

🔁 Автоматическое обновление данных (Refetch при фокусе и маунте)
Для обеспечения мгновенного обновления данных на стороне медсестры после действий врача
в apiNurseSlice были добавлены параметры:

refetchOnFocus: true — автоматически обновляет данные при возврате пользователя на вкладку приложения;
refetchOnReconnect: true — повторно запрашивает данные после восстановления сетевого соединения.

Кроме того, в компоненте PatientDetails у хука
useGetRecommendationByPatientIdQuery установлена опция
refetchOnMountOrArgChange: true,
которая гарантирует, что при каждом открытии страницы пациентских данных
RTK Query делает свежий запрос на сервер, даже если кэш ещё не истёк.
В результате данные статусов рекомендаций теперь обновляются автоматически и синхронно
между панелями врача и медсестры — без необходимости ручного обновления страницы или useEffect().