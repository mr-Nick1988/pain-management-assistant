# Pain Management Assistant - Frontend

## Описание проекта
Фронтенд приложения для управления болью в медицинских учреждениях. Построен на React + TypeScript + Vite с использованием Redux Toolkit Query для управления состоянием и API.

## Технологический стек
- **React 19.1.1** - основной фреймворк
- **TypeScript 5.8.3** - типизация
- **Vite 7.1.2** - сборщик и dev-сервер
- **Redux Toolkit 2.9.0** - управление состоянием
- **React Router DOM 7.9.1** - роутинг
- **Tailwind CSS 4.0.0** - стилизация

## Структура проекта

### Компоненты (`/src/components/`)
Реализованные компоненты:
- **Login.tsx** (4KB) - Авторизация пользователей
- **AdminPanel.tsx** (7KB) - Панель администратора для управления пользователями
- **DoctorDashboard.tsx** (7KB) - Дашборд доктора с рекомендациями
- **AddPatient.tsx** (4KB) - Форма добавления пациента
- **PatientRecommendationForm.tsx** (8KB) - Форма работы с рекомендациями
- **PersonsList.tsx** (2KB) - Список пользователей системы
- **ChangeCredentials.tsx** (5KB) - Смена логина и пароля
- **Navigation.tsx** (1KB) - Навигационное меню
- **Register.tsx** (2KB) - Регистрация пользователей

Заготовки компонентов (пустые файлы):
- **AnesthesiologistDashboard.tsx** (0 байт) - планируется дашборд анестезиолога
- **EscalationsList.tsx** (0 байт) - планируется список эскалаций

### API слои (`/src/api/api/`)
- **apiPersonSlice.ts** (1KB) - API для авторизации и смены креденшиалов
- **apiAdminSlice.ts** (1KB) - API для управления пользователями
- **apiDoctorSlice.ts** (3KB) - API для работы с пациентами и рекомендациями
- **apiAnesthesiologistSlice.ts** (1KB) - API для анестезиолога (в разработке)

### Типы данных (`/src/types/`)
- **personRegister.ts** - Типы для пользователей, ролей, авторизации
- **doctor.ts** - Типы для рекомендаций и пациентов
- **anesthesiologist.ts** - Типы для модуля анестезиолога

### Роутинг (`/src/routes/`)
- **AppRoutes.tsx** - Основные маршруты приложения
- **ProtectedRoute.tsx** - Компонент защищенных маршрутов

Настроенные маршруты:
- `/login` - Авторизация
- `/admin` - Панель администратора
- `/doctor` - Дашборд доктора
- `/anesthesiologist` - Дашборд анестезиолога (компонент пустой)
- `/change-credentials` - Смена креденшиалов

### Redux Store (`/src/store/`)
Настроен store с подключенными API слайсами:
- apiAdminSlice
- apiPersonSlice  
- apiDoctorSlice

## Реализованный функционал

### Модуль авторизации
- Логин с сохранением данных в localStorage
- Смена временных креденшиалов при первом входе
- Защищенные маршруты с проверкой авторизации

### Модуль администратора
- Создание пользователей с ролями (ADMIN, DOCTOR, NURSE, ANESTHESIOLOGIST)
- Просмотр списка всех пользователей
- Удаление пользователей по personId
- Обновление данных пользователей

### Модуль доктора
- Просмотр списка рекомендаций
- Создание новых пациентов
- Работа с рекомендациями (одобрение/отклонение)
- Добавление комментариев к рекомендациям
- **Поиск пациентов:** поиск по любым критериям (имя, фамилия, дата рождения, страховка, MRN)

### UI/UX
- Современный дизайн с Tailwind CSS
- Адаптивная верстка
- Модальные окна для форм
- Обработка состояний загрузки и ошибок

## В разработке
- Модуль анестезиолога (компоненты созданы, но пустые)
- Список эскалаций
- Расширенная работа с протоколами

## Архитектурные решения
- Использование RTK Query для кэширования и управления API запросами
- Разделение API по доменам (admin, doctor, person, anesthesiologist)
- Строгая типизация всех компонентов и API
- Модульная структура с четким разделением ответственности





## Хронология разработки модуля анестезиолога

### 20.09.2025 - Реализация модуля анестезиолога
**Разработчик:** Ник

#### Созданные компоненты и файлы:

**1. Типы данных (`/src/types/anesthesiologist.ts`)**
- `EscalationStatus` enum - статусы эскалаций (PENDING, IN_REVIEW, RESOLVED, REJECTED)
- `ProtocolStatus` enum - статусы протоколов (DRAFT, PENDING_APPROVAL, APPROVED, REJECTED)
- `EscalationPriority` enum - приоритеты эскалаций (LOW, MEDIUM, HIGH, CRITICAL)
- `Escalation` interface - структура эскалации с полями patientName, doctorName, rejectedReason, priority, status
- `Protocol` interface - структура протокола с версионированием, комментариями, статусом
- `ProtocolComment` interface - комментарии к протоколам с автором и временными метками
- `CreateProtocolRequest` и `UpdateProtocolRequest` - DTO для создания и обновления протоколов

**2. API слой (`/src/api/api/apiAnesthesiologistSlice.ts`)**
Создан RTK Query API слайс с эндпоинтами:
- `getEscalations` - получение списка эскалаций
- `takeEscalation` - взятие эскалации в работу
- `getProtocolsByEscalation` - получение протоколов по эскалации
- `createProtocol` - создание нового протокола
- `updateProtocol` - обновление протокола
- `approveProtocol` - утверждение протокола
- `rejectProtocol` - отклонение протокола
- `getProtocolComments` - получение комментариев к протоколу
- `addProtocolComment` - добавление комментария
- `sendQuestionToDoctor` - отправка вопроса доктору
- `resolveEscalation` - завершение эскалации

**3. Основной компонент (`/src/components/AnesthesiologistDashboard.tsx`)**
Реализован главный дашборд анестезиолога с:
- **Вкладочной навигацией:** Overview, Escalations, Protocols
- **Статистическими карточками:** Pending, Critical, High Priority, In Review escalations
- **Быстрыми действиями:** переход к эскалациям и создание протоколов
- **Превью последних эскалаций** с возможностью выбора для работы
- **Интеграцией с дочерними компонентами:** EscalationsList и ProtocolEditor
- **Обработкой состояний загрузки и ошибок**

**4. Список эскалаций (`/src/components/EscalationsList.tsx`)**
Компонент для работы со списком эскалаций:
- **Фильтрация по статусу и приоритету**
- **Поиск по имени пациента и доктора**
- **Сортировка по дате создания и приоритету**
- **Действия:** взятие в работу, отправка вопроса доктору
- **Отображение детальной информации** по каждой эскалации

**5. Редактор протоколов (`/src/components/ProtocolEditor.tsx`)**
Продвинутый компонент для работы с протоколами:
- **Создание новых протоколов** с заголовком и содержимым
- **Редактирование существующих протоколов** с версионированием
- **Система комментариев** с возможностью добавления и просмотра
- **Утверждение/отклонение протоколов** с обязательными комментариями
- **Завершение эскалаций** после утверждения протокола
- **Безопасная работа с optional chains** (исправлены ESLint ошибки)

#### Интеграция с системой:

**1. Роутинг (`/src/routes/AppRoutes.tsx`)**
- Добавлен защищенный маршрут `/anesthesiologist`
- Подключен AnesthesiologistDashboard компонент

**2. Экспорты (`/src/exports/exports.ts`)**
- Добавлены экспорты всех компонентов модуля анестезиолога
- Обеспечена правильная структура импортов

**3. Redux Store **
-  подключил `apiAnesthesiologistSlice` к основному store
- Добавил middleware для корректной работы RTK Query



#### Архитектурные особенности модуля:

**1. Разделение ответственности:**
- Dashboard - общий обзор и навигация
- EscalationsList - работа со списком эскалаций
- ProtocolEditor - создание и редактирование протоколов

**2. Типизация:**
- Строгая типизация всех API запросов и ответов
- Использование TypeScript enums для статусов и приоритетов
- Валидация данных на уровне интерфейсов

**3. Состояние и кэширование:**
- RTK Query для автоматического кэширования API данных
- Оптимистичные обновления для улучшения UX
- Правильная обработка состояний загрузки и ошибок

**4. UX/UI особенности:**
- Адаптивный дизайн с использованием CSS Grid и Flexbox
- Модальные окна для форм
- Цветовая индикация приоритетов и статусов эскалаций
- Быстрые действия и горячие клавиши для повышения продуктивности

#### Следующие шаги:
1. Подключение `apiAnesthesiologistSlice` к Redux store
2. Тестирование интеграции с backend API
3. Добавление unit тестов для компонентов
4. Оптимизация производительности и UX

---
*Разработчик: Ник*  
*Последнее обновление: 20.09.2025*

## 24.09.2025 - Отладка и восстановление функционала создания пациента

**Разработчик:** Ник

#### Описание проблемы:

В модуле доктора была обнаружена критическая ошибка, не позволявшая создавать новых пациентов. При попытке отправки формы фронтенд получал ошибку `500 Internal Server Error`. Кроме того, на дашборде доктора отсутствовала кнопка для вызова формы создания пациента.

#### Процесс отладки и исправления:

**1. Восстановление UI в `DoctorDashboard.tsx`**
- **Проблема:** В компоненте `DoctorDashboard` полностью отсутствовала логика для вызова модального окна `AddPatient`.
- **Решение:**
    - Добавлена кнопка "Add New Patient".
    - Внедрено состояние `isAddPatientModalOpen` для управления видимостью модального окна.
    - Реализована логика открытия/закрытия окна и обновления данных (`refetch`) после успешного создания пациента.

**2. Отладка ошибки 500 `Internal Server Error`**
- **Анализ логов:** Бэкенд логи показали ошибку `java.lang.RuntimeException: Person not found`, вызванную тем, что в запросе на создание пациента передавалось пустое поле `createdBy: ''`.
- **Проблема:** Фронтенд не получал и не передавал логин пользователя, создающего пациента.

**3. Исправление логики в `AddPatient.tsx`**
- **Решение:**
    - В `handleSubmit` добавлено получение логина текущего пользователя из `localStorage.getItem("userLogin")`.
    - Этот логин теперь корректно передается в поле `createdBy` при вызове мутации `createPatient`.

**4. Обновление API и типов**
- **`apiDoctorSlice.ts`:** Эндпоинт `createPatient` был обновлен для передачи `createdBy` в качестве query-параметра (`/api/doctor/patients?createdBy=...`).
- **`doctor.ts`:** В интерфейс `PatientCreation` было добавлено обязательное поле `createdBy: string`.

#### Ключевые результаты:

1.  **Восстановлен функционал:** Доктора снова могут создавать пациентов через интерфейс `DoctorDashboard`.
2.  **Исправлена интеграция:** Устранена ошибка `Person not found` путем корректной передачи данных о создателе пациента с фронтенда на бэкенд.
3.  **Улучшена стабильность:** Проблема, блокировавшая ключевой сценарий использования приложения, была полностью решена.

---
*Разработчик: Ник*  
*Последнее обновление: 24.09.2025*

## 27.09.2025 - Исправление функционала поиска пациентов для доктора

**Разработчик:** Ник

#### Описание проблемы:

В модуле доктора была обнаружена критическая проблема с поиском пациентов. При нажатии кнопки "Search" ничего не происходило - запросы не отправлялись на бэкенд, и пользователи не могли найти существующих пациентов. Кроме того, бэкенд логика поиска требовала одновременного заполнения всех полей, что делало поиск практически невозможным.

#### Процесс отладки и исправления:

**1. Анализ проблемы кнопки Search (Frontend)**
- **Проблема:** В `SearchPatients.tsx` использовался `useSearchPatientsQuery` с параметром `skip: true` и попыткой вызова `refetch()` при нажатии кнопки.
- **Корень проблемы:** RTK Query имеет фундаментальное ограничение - `refetch()` не работает на запросах с `skip: true`. Пропущенные запросы не могут быть перезапущены через `refetch()`.
- **Решение:** 
  - Заменен `useSearchPatientsQuery` на `useLazySearchPatientsQuery` для ручного управления запросами.
  - Добавлен `triggerSearch` для явной отправки запроса при нажатии кнопки Search.
  - Обновлен импорт в `apiDoctorSlice.ts` - добавлен `useLazySearchPatientsQuery`.

**2. Исправление логики поиска на бэкенде**
- **Проблема:** Бэкенд требовал одновременного заполнения всех полей поиска (MRN ИЛИ insurance ИЛИ dateOfBirth + firstName + lastName), что делало поиск неудобным.
- **Анализ кода:** Логика в `searchPatients()` использовала жесткие условия `else if`, требующие все поля одновременно.
- **Решение:** Переписана логика поиска для поддержки поиска по любым предоставленным параметрам:
  - Поиск по MRN (если предоставлен)
  - Поиск по insurance (если предоставлен)  
  - Поиск по имени (firstName + lastName, опционально с dateOfBirth)
  - Удаление дубликатов при нахождении пациента несколькими способами

**3. Обновление состояния компонента SearchPatients**
- **Добавлен флаг `hasSearched`:** Для корректного отображения сообщения "No patients found" только после выполнения поиска.
- **Улучшена логика отображения:** Результаты показываются только после успешного поиска.

#### Ключевые результаты:

1. **Восстановлен функционал поиска:** Доктора могут успешно искать пациентов по любым критериям (имя, фамилия, дата рождения, страховка, MRN).
2. **Исправлена архитектурная проблема:** Замена на Lazy Query решила фундаментальную проблему RTK Query с пропущенными запросами.
3. **Улучшен UX:** Поиск работает по любому набору параметров, а не требует заполнения всех полей одновременно.
4. **Полная интеграция:** Фронтенд корректно отправляет запросы, бэкенд правильно обрабатывает поиск, результаты отображаются пользователю.

**Тестирование подтверждено:** Поиск пациентов работает корректно с любым количеством заполненных полей.

---
*Разработчик: Ник*  
*Последнее обновление: 27.09.2025*

### 28.09.2025 - Nick1988 (mr-Nick1988)
**Рефакторинг UI/UX - Отдельные страницы для лучшего UX**

#### Рефакторинг панели администратора
- **Перенос создания пользователей из модального окна на отдельную страницу** (`/admin/create-person`)
- Создан выделенный компонент `CreatePerson.tsx` для управления пользователями
- Обновлен `AdminPanel.tsx` с навигацией на отдельную страницу вместо модального окна
- Сохранена вся существующая функциональность (создание, редактирование, удаление пользователей)
- Улучшен пользовательский опыт с полноэкранными формами

#### Рефакторинг дашборда доктора
- **Перенос списка пациентов на отдельную страницу** (`/doctor/patients-list`)
- Создан компонент `PatientsList.tsx` с полным управлением пациентами
- Обновлен `DoctorDashboard.tsx` для фокуса только на рекомендациях
- Добавлена кнопка навигации "My Patients" для лучшего UX
- Сохранена вся функциональность пациентов (добавление, просмотр деталей, поиск)

#### Технические улучшения
- Добавлены новые маршруты: `/admin/create-person`, `/doctor/patients-list`
- Обновлена конфигурация экспортов компонентов и маршрутизации
- Исправлены ошибки TypeScript в логике одобрения рекомендаций
- Сохранены существующие контракты API и функциональность
- Нет критических изменений в существующих рабочих процессах

#### Преимущества
- Более чистые и сфокусированные дашборды
- Лучший мобильный опыт с полноэкранной навигацией
- Улучшена организация кода и поддерживаемость
- Повышен пользовательский опыт с выделенными страницами для конкретных задач
